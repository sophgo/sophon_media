


bmapive_case=(
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 1 -q 10 -o case0_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 2 -q 10 -o case1_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 3 -q 10 -o case2_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 4 -q 10 -o case3_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 5 -q 10 -o case4_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 6 -q 10 -o case5_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 7 -q 10 -o case6_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 1 -q 18 -o case7_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 2 -q 18 -o case8_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 3 -q 18 -o case9_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 4 -q 18 -o case10_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 5 -q 18 -o case11_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 6 -q 18 -o case12_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 7 -q 18 -o case13_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 1 -q 28 -o case14_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 2 -q 28 -o case15_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 3 -q 28 -o case16_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 4 -q 28 -o case17_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 5 -q 28 -o case18_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 6 -q 28 -o case19_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 7 -q 28 -o case20_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 1 -q 40 -o case21_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 2 -q 40 -o case22_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 3 -q 40 -o case23_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 4 -q 40 -o case24_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 5 -q 40 -o case25_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 6 -q 40 -o case26_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 7 -q 40 -o case27_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 1 -r 1000 -o case28_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 2 -r 1000 -o case29_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 3 -r 1000 -o case30_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 4 -r 1000 -o case31_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 5 -r 1000 -o case32_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 6 -r 1000 -o case33_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 7 -r 1000 -o case34_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 1 -r 2000 -o case35_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 2 -r 2000 -o case36_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 3 -r 2000 -o case37_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 4 -r 2000 -o case38_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 5 -r 2000 -o case39_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 6 -r 2000 -o case40_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 7 -r 2000 -o case41_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 1 -r 4000 -o case42_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 2 -r 4000 -o case43_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 3 -r 4000 -o case44_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 4 -r 4000 -o case45_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 5 -r 4000 -o case46_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 6 -r 4000 -o case47_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -g 7 -r 4000 -o case48_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 2  -i 1080p_yuv420p.yuv -g 1 -r 4000 -o case49_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 4  -i 1080p_yuv420p.yuv -g 5 -r 4000 -o case50_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 10 -i 1080p_yuv420p.yuv -g 2 -r 4000 -o case51_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 13 -i 1080p_yuv420p.yuv -g 7 -r 4000 -o case52_1080_g1_q10.h264"
"bmvpuenc -w 352 -h 288 -m 16 -i 352x288_I420.yuv -f 0 -g 6  -o case53_1080_g1_q10.h264"
"bmvpuenc -w 352 -h 288 -m 16 -i 352x288_I420.yuv -f 0 -g 6  -o case54_1080_g1_q10.h264"
"bmvpuenc -w 352 -h 288 -m 16 -i 352x288_I420.yuv -f 0 -g 6  -o case55_1080_g1_q10.h264"


"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 1 -q 10 -o case56_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 2 -q 10 -o case57_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 3 -q 10 -o case58_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 4 -q 10 -o case59_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 5 -q 10 -o case60_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 6 -q 10 -o case61_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 7 -q 10 -o case62_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 1 -q 18 -o case63_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 2 -q 18 -o case64_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 3 -q 18 -o case65_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 4 -q 18 -o case66_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 5 -q 18 -o case67_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 6 -q 18 -o case68_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 7 -q 18 -o case69_1080_g1_q10.h265"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 1 -q 28 -o case70_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 2 -q 28 -o case71_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 3 -q 28 -o case72_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 4 -q 28 -o case73_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 5 -q 28 -o case74_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 6 -q 28 -o case75_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 7 -q 28 -o case76_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 1 -q 40 -o case77_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 2 -q 40 -o case78_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 3 -q 40 -o case79_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 4 -q 40 -o case80_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 5 -q 40 -o case81_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 6 -q 40 -o case82_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 7 -q 40 -o case83_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 1 -r 1000 -o case84_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 2 -r 1000 -o case85_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 3 -r 1000 -o case86_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 4 -r 1000 -o case87_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 5 -r 1000 -o case88_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 6 -r 1000 -o case89_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 7 -r 1000 -o case90_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 1 -r 2000 -o case91_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 2 -r 2000 -o case92_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 3 -r 2000 -o case93_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 4 -r 2000 -o case94_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 5 -r 2000 -o case95_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 6 -r 2000 -o case96_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 7 -r 2000 -o case97_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 1 -r 4000 -o case98_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 2 -r 4000 -o case99_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 3 -r 4000 -o case100_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 4 -r 4000 -o case101_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 5 -r 4000 -o case102_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 6 -r 4000 -o case103_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -i 1080p_yuv420p.yuv -c 1 -g 7 -r 4000 -o case104_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 2  -i 1080p_yuv420p.yuv -c 1 -g 1 -r 4000 -o case105_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 4  -i 1080p_yuv420p.yuv -c 1 -g 5 -r 4000 -o case106_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 10 -i 1080p_yuv420p.yuv -c 1 -g 2 -r 4000 -o case107_1080_g1_q10.h264"
"bmvpuenc -w 1920 -h 1080 -m 13 -i 1080p_yuv420p.yuv -c 1 -g 7 -r 4000 -o case108_1080_g1_q10.h264"
"bmvpuenc -w 352 -h 288 -m 16 -i 352x288_I420.yuv -c 1 -f 0 -g 6  -o case109_1080_g1_q10.h264"
"bmvpuenc -w 352 -h 288 -m 16 -i 352x288_I420.yuv -c 1 -f 0 -g 6  -o case110_1080_g1_q10.h264"
"bmvpuenc -w 352 -h 288 -m 16 -i 352x288_I420.yuv -c 1 -f 0 -g 6  -o case111_1080_g1_q10.h264"
)


counter=0
check_num=0

timeout_duration=300 #超时时间（单位：秒)

host_name=dailytest
host_ip=172.28.141.219
host_passwd=dailytest
src_dir="/home/dailytest/Athena2/Multimedia/ve"
input_dir="input"
input_file=(
"1080p_nv12.yuv"
"1080p_yuv420p.yuv"
"1080p_yuv422p.yuv"
"1920x1088_420.yuv"
"352x288_I420.yuv"
"352x288_nv12.yuv"
"CBR2925_h265.mp4"
"bilibilibjx.264"
"huangfeihong-h265-1920x1080.mp4"
"station.avi"
"station_1080p.265"
"station_4mb_200.264"
"station_4mb_200.265"

)
ref_dir="ref/bmapi"

dest=/data/bmapi
golden_dir=bmapi_ref
check_num=0

# action==0, test case
# action==1, make golden file
action=$1

function scp_file()
{

file_addr=$1
name=$2
ipaddres=$3
dest_path=$4
# name=$3
passwd=$5

to_remote=$6 #if 1 localhost copy remote machine if 2 remote machine copy to loaclhost


/usr/bin/expect<<-EOF
set cmp 1
if { $to_remote == "1" } {
    spawn sudo scp -r $name@$ipaddres:$file_addr $dest_path

} else {
    spawn sudo scp -r $file_addr $name@$ipaddres:$dest_path
}

expect {
  "密码："
        {
          send "$passwd\n"
        }
   "pass"
        {
          send "$passwd\n"
        }
   "yes/no"
        {
          sleep 5
        #   send_user "send yes"
          send "yes\n"
        }
   eof
    {
        sleep 5
        send_user "eof\n"
    }
}

# send "exit\r"
expect eof
EOF
}

function make_golden(){
    num=$1

    ${bmapive_case[num]}
    sudo md5sum case${num}* >> ${golden_dir}/case${num}.md5

    scp_file ${golden_dir}/case${num}.md5 ${host_name} ${host_ip} ${src_dir}/${ref_dir} ${host_passwd} 2

    find . -name case*
    ret=$?
    if [ ${ret} -ne 0 ]; then
        rm -rf case*
    fi
}

function compare_md5(){
    num=$1

    scp_file ${src_dir}/${ref_dir}/case${num}.md5 ${host_name} ${host_ip} . ${host_passwd} 1
    md5sum -c case${num}.md5 >> bmapi_ve.log
    echo

    sudo rm case${num}.md5
}

function test_start(){
    compare=$1
    num=$2
    line=$3

    echo $line
    timeout ${timeout_duration} ${line}
    exit_code=$?
    sleep 1
    if [ ${exit_code} -eq 0 ]; then
        echo case${num}: $line success
        if [ ${compare} -eq 1 ]; then
            compare_md5 ${num}
        fi

    else
        if [ ${exit_code} -eq 124 ]; then
            if [ ${compare} -eq 1 ]; then
                echo "Command timed out.$line"
                echo ${line} "Command timed out." >> bmapi_ve.log
                printf "\n" >> bmapi_ve.log
            else
                echo case${num}: $line success >> bmapi_ve.log
                printf "\n" >> bmapi_ve.log
            fi
        else
            echo "Command encountered an error.$line"
            echo ${line} "Command Failed" >> bmapi_ve.log
            printf "\n" >> bmapi_ve.log
        fi

    fi

    find . -name case*
    ret=$?
    if [ ${ret} -ne 0 ]; then
        rm -rf case*
    fi
}

# test_all_case 1个输入参数
#       0 自动化测试
#       1 生成golden文件，进行比较，生成的golden文件传到服务器
function test_all_case(){
    echo action=${action}

    if [ ${action} -eq 1 ]; then
        echo "golden_dir:${golden_dir}"
        if [ -d ${golden_dir} ]; then
            rm -r ${golden_dir}
            mkdir -p ${golden_dir}
        else
            mkdir -p ${golden_dir}
        fi
    fi

    if [ -e "bmapi_ve.log" ]; then
        rm -rf bmapi_ve.log
    fi

    # sudo  mkdir ${dest}
    # scp_file ${src_dir}/${input_dir}/* ${host_name} ${host_ip} ${dest} ${host_passwd} 1

    # for ((i=0; i<${#input_file[@]}; i++))
    # do
    #     echo ${src_dir}/${input_dir}/${input_file[i]}
    #     scp_file ${src_dir}/${input_dir}/${input_file[i]} ${host_name} ${host_ip} ${dest} ${host_passwd} 1
    # done

    for ((i=0; i<${#bmapive_case[@]}; i++))
    do

        if [ ${action} -eq 0 ]; then
            # run case
            test_start 1 ${i} "${bmapive_case[i]}"
        else
            # make golden file
            make_golden ${i}
        fi

    done

    if [ ${action} -eq 0 ]; then

        for ((i=0; i<${#test_bmapi_ve_case_nocmp[@]}; i++))
        do
            test_start 0 ${i} "${test_bmapi_ve_case_nocmp[i]}"
        done
    fi

    # sudo rm -r ${dest}
}

test_all_case
